@page "/movies/edit/{Id:int}"

@inject IMoviesApi Movies
@inject NavigationManager Nav
@inject PersistentComponentState AppState

<h1 class="text-2xl font-semibold mb-2">Edit Movie</h1>

<p class="text-sm text-gray-500 mb-3">rendermode: @RendererInfo.Name</p>

@if (_loading)
{
    <p>Loading...</p>
}
else if (_error is not null)
{
    <p class="text-red-600">@_error</p>
}
else
{
    <EditForm Model="_model" OnValidSubmit="HandleSubmit" class="max-w-xl">
        <DataAnnotationsValidator />
        <ValidationSummary class="mb-3 text-sm text-red-600" />
        <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
            <InputText class="block w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-blue-500 focus:ring-blue-500" @bind-Value="_model.Title" />
            <ValidationMessage For="() => _model.Title" class="text-sm text-red-600" />
        </div>
        <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Director</label>
            <InputText class="block w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-blue-500 focus:ring-blue-500" @bind-Value="_model.Director" />
            <ValidationMessage For="() => _model.Director" class="text-sm text-red-600" />
        </div>
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Rating</label>
            <InputNumber class="block w-32 rounded-md border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-blue-500 focus:ring-blue-500" @bind-Value="_model.Rating" />
            <ValidationMessage For="() => _model.Rating" class="text-sm text-red-600" />
        </div>
        <div class="flex items-center gap-2">
            <button class="inline-flex items-center rounded-md bg-blue-600 px-3 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700" type="submit">Save</button>
            <button class="inline-flex items-center rounded-md border border-gray-400 px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50" type="button" @onclick="GoBack">Cancel</button>
        </div>
    </EditForm>
}

@code {
    [Parameter] public int Id { get; set; }
    private string CacheKey => $"Movies_Edit_{Id}";

    private bool _loading = true;
    private string? _error;
    private UpdateMovieRequest _model = new() { Id = 0, Title = string.Empty, Rating = 0 };

    protected override async Task OnParametersSetAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        _loading = true;
        _error = null;
        try
        {
            if (AppState.TryTakeFromJson<GetMovieResponse>(CacheKey, out var cached) && cached is not null)
            {
                _model = new UpdateMovieRequest
                {
                    Id = cached.Id,
                    Title = cached.Title,
                    Director = cached.Director,
                    Rating = cached.Rating
                };
            }
            else
            {
                var response = await Movies.GetByIdAsync(new GetMovieRequest { Id = Id });
                if (response is null)
                {
                    _error = "Movie not found";
                    return;
                }
                _model = new UpdateMovieRequest
                {
                    Id = response.Id,
                    Title = response.Title,
                    Director = response.Director,
                    Rating = response.Rating
                };
                AppState.RegisterOnPersisting(async () =>
                {
                    AppState.PersistAsJson(CacheKey, new GetMovieResponse
                    {
                        Id = _model.Id,
                        Title = _model.Title,
                        Director = _model.Director,
                        Rating = _model.Rating
                    });
                    await Task.CompletedTask;
                });
            }
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task HandleSubmit()
    {
        var success = await Movies.UpdateAsync(_model);
        if (success) Nav.NavigateTo("/movies");
    }
    private void GoBack() => Nav.NavigateTo("/movies");
}
